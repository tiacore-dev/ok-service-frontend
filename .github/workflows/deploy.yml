name: Deploy to Server

on:
  push:
    branches: [ master, stage, dev ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      API_URL_PROD: ${{ secrets.API_URL_PROD }}
      API_URL_DEV: ${{ secrets.API_URL_DEV }}
      API_URL_STAGE: ${{ secrets.API_URL_STAGE }}
      API_URL_TEST: ${{ secrets.API_URL_TEST }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set API URLs from secrets
        id: set-urls
        run: |
          if [ "${GITHUB_REF_NAME}" = "master" ]; then
            echo "api_url=${API_URL_PROD}" >> $GITHUB_OUTPUT
          elif [ "${GITHUB_REF_NAME}" = "dev" ]; then
            echo "api_url=${API_URL_DEV}" >> $GITHUB_OUTPUT
          elif [ "${GITHUB_REF_NAME}" = "stage" ]; then
            echo "api_url=${API_URL_STAGE}" >> $GITHUB_OUTPUT
          else
            echo "api_url=${API_URL_TEST}" >> $GITHUB_OUTPUT
          fi

      - name: Echo selected API URL
        run: |
          api_url="${{ steps.set-urls.outputs.api_url }}"
          if [ -z "$api_url" ]; then
            echo "‚ö†Ô∏è API URL is empty"
          else
            safe_prefix="${api_url:0:24}"
            echo "üì° Using API URL (prefix): ${safe_prefix}..."
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/ok-service-frontend:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/ok-service-frontend:cache
          cache-to: type=inline
          build-args: |
            REACT_APP_API_URL=${{ steps.set-urls.outputs.api_url }}
            REACT_APP_WP=${{ secrets.APP_WP }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ==== –í–´–ë–û–† SSH-–ö–õ–Æ–ß–ê/–Æ–ó–ï–†–ê/IP –ü–û –í–ï–¢–ö–ï ====
      - name: Setup SSH for Master
        if: github.ref_name == 'master'
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY_MASTER }}

      - name: Set Master host vars
        if: github.ref_name == 'master'
        run: |
          echo "SSH_USER=${{ secrets.SSH_USER_MASTER }}" >> $GITHUB_ENV
          echo "SERVER_IP=${{ secrets.SERVER_IP_MASTER }}" >> $GITHUB_ENV

      - name: Setup SSH for Dev
        if: github.ref_name == 'dev'
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY_DEV }}

      - name: Set Dev host vars
        if: github.ref_name == 'dev'
        run: |
          echo "SSH_USER=${{ secrets.SSH_USER_DEV }}" >> $GITHUB_ENV
          echo "SERVER_IP=${{ secrets.SERVER_IP_DEV }}" >> $GITHUB_ENV

      - name: Setup SSH for Stage
        if: github.ref_name == 'stage'
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY_STAGE }}

      - name: Set Stage host vars
        if: github.ref_name == 'stage'
        run: |
          echo "SSH_USER=${{ secrets.SSH_USER_STAGE }}" >> $GITHUB_ENV
          echo "SERVER_IP=${{ secrets.SERVER_IP_STAGE }}" >> $GITHUB_ENV
      # ============================================

      - name: Determine Deployment Path and Tag
        run: |
          if [[ "${{ github.ref_name }}" == "master" ]]; then
            echo "DEPLOY_PATH=apps/ok-service-frontend" >> $GITHUB_ENV
          elif [[ "${{ github.ref_name }}" == "dev" ]]; then
            echo "DEPLOY_PATH=apps/ok-service-frontend-dev" >> $GITHUB_ENV
          elif [[ "${{ github.ref_name }}" == "stage" ]]; then
            echo "DEPLOY_PATH=apps/ok-service-frontend-stage" >> $GITHUB_ENV
          else
            echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –≤–µ—Ç–∫–∞! –ü—Ä–µ—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å."
            exit 1
          fi
          echo "DEPLOY_TAG=${{ github.sha }}" >> $GITHUB_ENV
          echo "DEPLOY_BRANCH=${{ github.ref_name }}" >> $GITHUB_ENV

      - name: Deploy Frontend
        env:
          SSH_USER: ${{ env.SSH_USER }}
          SERVER_IP: ${{ env.SERVER_IP }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
          DEPLOY_TAG: ${{ env.DEPLOY_TAG }}
          DEPLOY_BRANCH: ${{ env.DEPLOY_BRANCH }}
        run: |
          echo "üöÄ –î–µ–ø–ª–æ–π –Ω–∞ ${SSH_USER}@${SERVER_IP} –≤ ${DEPLOY_PATH} (branch: ${DEPLOY_BRANCH}) ..."
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=30 "${SSH_USER}@${SERVER_IP}" << 'EOF'
            set -euo pipefail

            export DOCKERHUB_USERNAME='${{ secrets.DOCKERHUB_USERNAME }}'
            export DOCKERHUB_TOKEN='${{ secrets.DOCKERHUB_TOKEN }}'
            export DEPLOY_TAG='${{ env.DEPLOY_TAG }}'
            export DEPLOY_BRANCH='${{ env.DEPLOY_BRANCH }}'
            export DEPLOY_PATH='${{ env.DEPLOY_PATH }}'

            # –ü—Ä–æ–≤–µ—Ä–∏–º –Ω–∞–ª–∏—á–∏–µ docker compose v2
            if ! docker compose version >/dev/null 2>&1; then
              echo "‚ùå Docker Compose v2 –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ docker-compose-plugin."
              exit 1
            fi

            cd "$DEPLOY_PATH" || { echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ $DEPLOY_PATH"; exit 1; }

            echo "‚û°Ô∏è git pull origin ${DEPLOY_BRANCH}"
            git fetch origin "${DEPLOY_BRANCH}"
            git checkout "${DEPLOY_BRANCH}" || true
            git pull --rebase origin "${DEPLOY_BRANCH}" || { echo "‚ùå git pull –Ω–µ —É–¥–∞–ª—Å—è"; exit 1; }

            echo "‚û°Ô∏è docker login"
            echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin \
              || { echo "‚ùå Docker login failed"; exit 1; }

            # –û–±–Ω–æ–≤–ª—è–µ–º .env —Å –Ω–æ–≤—ã–º —Ç–µ–≥–æ–º (–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —é–∑–µ—Ä–Ω–µ–π–º)
            touch .env
            if grep -q "^TAG=" .env; then
              sed -i "s/^TAG=.*/TAG=$DEPLOY_TAG/" .env
            else
              echo "TAG=$DEPLOY_TAG" >> .env
            fi
            grep -q "^DOCKERHUB_USERNAME=" .env || echo "DOCKERHUB_USERNAME=$DOCKERHUB_USERNAME" >> .env

            echo "‚û°Ô∏è docker compose down (–º—è–≥–∫–æ)"
            docker compose down || true

            echo "‚û°Ô∏è docker compose pull"
            docker compose pull --ignore-pull-failures || true

            echo "‚û°Ô∏è docker compose up -d"
            docker compose up -d --remove-orphans \
              || { echo "‚ùå docker compose up failed"; exit 1; }

            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω"
          EOF

  notify:
    name: üì¨ Notifications
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy]
    if: always()

    steps:
      - name: Checkout (for commit message fallback)
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install jq (if missing)
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y >/dev/null
            sudo apt-get install -y jq >/dev/null
          fi

      - name: üì¨ Telegram + Jira/OpenProject comments
        continue-on-error: true
        env:
          # Telegram
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}

          # Jira
          JIRA_URL: ${{ secrets.JIRA_URL }}                 # https://your-domain.atlassian.net
          JIRA_USER: ${{ secrets.JIRA_USER }}               # –æ–±—ã—á–Ω–æ email
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

          # OpenProject
          OPENPROJECT_URL: ${{ secrets.OPENPROJECT_URL }}
          OPENPROJECT_API_TOKEN: ${{ secrets.OPENPROJECT_API_TOKEN }}

          # optional: –∏–º—è —Å–µ—Ä–≤–∏—Å–∞
          SERVICE_NAME: ok-frontend

        run: |
          set -euo pipefail

          REF_NAME="${{ github.ref_name }}"
          SHA="${{ github.sha }}"
          SHORT_SHA="${SHA:0:8}"
          REPO="${{ github.repository }}"
          RUN_URL="https://github.com/${REPO}/actions/runs/${{ github.run_id }}"
          REPO_URL="https://github.com/${REPO}"

          BUILD_STATUS="${{ needs['build-and-push'].result }}"
          DEPLOY_STATUS="${{ needs.deploy.result }}"

          # –∞–≥—Ä–µ–≥–∏—Ä—É–µ–º –∏—Ç–æ–≥ –∫–∞–∫ —É —Ç–µ–±—è –±—ã–ª–æ
          if [ "${BUILD_STATUS}" = "success" ] && [ "${DEPLOY_STATUS}" = "success" ]; then
            RESULT="success"
          elif [ "${BUILD_STATUS}" = "failure" ] || [ "${DEPLOY_STATUS}" = "failure" ]; then
            RESULT="failed"
          else
            RESULT="partial"
          fi

          # commit message / author (—Ñ–æ–ª–±—ç–∫, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç head_commit.*)
          COMMIT_MESSAGE="$(git log -1 --pretty=%B || true)"
          AUTHOR_NAME="$(git log -1 --pretty=%an || true)"
          AUTHOR_LOGIN="${{ github.actor }}"

          # –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø–æ –≤–µ—Ç–∫–µ
          case "${REF_NAME}" in
            dev)    ENV_NAME="dev" ;;
            stage)  ENV_NAME="stage" ;;
            master) ENV_NAME="prod" ;;
            *)      ENV_NAME="${REF_NAME}" ;;
          esac

          # HTML escape –¥–ª—è Telegram
          html_escape() {
            printf '%s' "$1" | sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g'
          }

          SAFE_MSG="$(html_escape "${COMMIT_MESSAGE}")"
          SAFE_AUTHOR="$(html_escape "${AUTHOR_NAME:-$AUTHOR_LOGIN}")"

          # extract Jira keys + OP ids
          extract_jira_keys() {
            printf '%s\n' "${COMMIT_MESSAGE}" \
              | grep -oiE '\b[A-Z][A-Z0-9]+-[0-9]+\b' \
              | tr '[:lower:]' '[:upper:]' \
              | sort -u
          }

          extract_op_ids() {
            printf '%s\n' "${COMMIT_MESSAGE}" \
              | grep -oE 'OP#[0-9]+' \
              | sed 's/OP#//g' \
              | sort -u
          }

          JIRA_KEYS="$(extract_jira_keys || true)"
          OP_IDS="$(extract_op_ids || true)"

          # --- Telegram header
          case "${RESULT}" in
            success) HEAD="‚úÖ <b>Frontend deploy —É—Å–ø–µ—à–µ–Ω</b>" ;;
            failed)  HEAD="üõë <b>–û—à–∏–±–∫–∞ —Ñ—Ä–æ–Ω—Ç–æ–≤–æ–≥–æ –¥–µ–ø–ª–æ—è</b>" ;;
            partial) HEAD="‚ÑπÔ∏è <b>Deploy partial</b> (build=${BUILD_STATUS}, deploy=${DEPLOY_STATUS})" ;;
            *)       HEAD="‚ÑπÔ∏è <b>Deploy status:</b> ${RESULT}" ;;
          esac

          TASKS_BLOCK=""
          if [ -n "${JIRA_KEYS:-}" ] || [ -n "${OP_IDS:-}" ]; then
            TASKS_BLOCK="üìå <b>–ó–∞–¥–∞—á–∏:</b>"

            if [ -n "${JIRA_KEYS:-}" ]; then
              TASKS_BLOCK="${TASKS_BLOCK}\n<b>Jira:</b>"
              for KEY in ${JIRA_KEYS}; do
                if [ -n "${JIRA_URL:-}" ]; then
                  URL="${JIRA_URL%/}/browse/${KEY}"
                  TASKS_BLOCK="${TASKS_BLOCK}
                  ‚Ä¢ <a href=\"${URL}\">${KEY}</a>"
                else
                  TASKS_BLOCK="${TASKS_BLOCK}
                  ‚Ä¢ ${KEY}"
                fi
              done
            fi

            if [ -n "${OP_IDS:-}" ]; then
              TASKS_BLOCK="${TASKS_BLOCK}\n<b>OpenProject:</b>"
              for ID in ${OP_IDS}; do
                if [ -n "${OPENPROJECT_URL:-}" ]; then
                  URL="${OPENPROJECT_URL%/}/work_packages/${ID}"
                  TASKS_BLOCK="${TASKS_BLOCK}\n‚Ä¢ <a href=\"${URL}\">OP#${ID}</a>"
                else
                  TASKS_BLOCK="${TASKS_BLOCK}\n‚Ä¢ OP#${ID}"
                fi
              done
            fi
          else
            TASKS_BLOCK="üìå <b>–ó–∞–¥–∞—á–∏:</b> –Ω–µ—Ç (–Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ OP#123, –Ω–∏ ABC-123)"
          fi

          EXTRA_LINK=""
          if [ "${RESULT}" != "success" ]; then
            EXTRA_LINK="\n\n<a href=\"${RUN_URL}\">üîç –û—Ç–∫—Ä—ã—Ç—å GitHub Actions</a>"
          fi

          TEXT="$(cat <<EOF
          ${HEAD}

          üß© <b>–°–µ—Ä–≤–∏—Å:</b> <code>${SERVICE_NAME}</code>
          üß© <b>Env:</b> <code>${ENV_NAME}</code>
          üì¶ <b>–í–µ—Ç–∫–∞:</b> <code>${REF_NAME}</code>
          üîñ <b>–ö–æ–º–º–∏—Ç:</b> <code>${SHORT_SHA}</code>
          üë§ <b>–ê–≤—Ç–æ—Ä:</b> <a href="https://github.com/${AUTHOR_LOGIN}">${SAFE_AUTHOR}</a>

          üìù <b>–°–æ–æ–±—â–µ–Ω–∏–µ:</b>
          <code>${SAFE_MSG}</code>

          ${TASKS_BLOCK}

          <a href="${RUN_URL}">üîó –û—Ç–∫—Ä—ã—Ç—å GitHub Actions</a>
          <a href="${REPO_URL}">üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π</a>${EXTRA_LINK}
          EOF
          )"

          # --- 1) Telegram send
          if [ -n "${TELEGRAM_BOT_TOKEN:-}" ] && [ -n "${TELEGRAM_CHAT_ID:-}" ]; then
            curl -sS "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              ${TELEGRAM_THREAD_ID:+-d message_thread_id="${TELEGRAM_THREAD_ID}"} \
              -d parse_mode=HTML \
              -d disable_web_page_preview=true \
              --data-urlencode "text=${TEXT}" >/dev/null || true
          else
            echo "Telegram creds missing, skip"
          fi

          # --- 2) Jira comments
          if [ -n "${JIRA_URL:-}" ] && [ -n "${JIRA_USER:-}" ] && [ -n "${JIRA_API_TOKEN:-}" ] && [ -n "${JIRA_KEYS:-}" ]; then
            COMMENT="Frontend deployed to ${ENV_NAME} via GitHub Actions run ${RUN_URL}"
            PAYLOAD="$(jq -n --arg body "$COMMENT" '{body:$body}')"

            for KEY in ${JIRA_KEYS}; do
              echo "Post comment to Jira ${KEY}"

              code="$(curl -s -o /tmp/jira_out -w "%{http_code}" \
                -u "${JIRA_USER}:${JIRA_API_TOKEN}" \
                -H "Content-Type: application/json" \
                -X POST "${JIRA_URL%/}/rest/api/3/issue/${KEY}/comment" \
                -d "${PAYLOAD}" || true)"

              if [ "$code" = "404" ] || [ "$code" = "400" ]; then
                code2="$(curl -s -o /tmp/jira_out2 -w "%{http_code}" \
                  -u "${JIRA_USER}:${JIRA_API_TOKEN}" \
                  -H "Content-Type: application/json" \
                  -X POST "${JIRA_URL%/}/rest/api/2/issue/${KEY}/comment" \
                  -d "${PAYLOAD}" || true)"
                [ "$code2" -ge 200 ] && [ "$code2" -lt 300 ] || echo "Jira comment failed for ${KEY} (http ${code2})"
              else
                [ "$code" -ge 200 ] && [ "$code" -lt 300 ] || echo "Jira comment failed for ${KEY} (http ${code})"
              fi
            done
          else
            echo "Jira creds or keys missing, skip Jira comments"
          fi

          # --- 3) OpenProject comments
          if [ -n "${OPENPROJECT_URL:-}" ] && [ -n "${OPENPROJECT_API_TOKEN:-}" ] && [ -n "${OP_IDS:-}" ]; then
            COMMENT="Frontend deployed to ${ENV_NAME} via GitHub Actions run ${RUN_URL}"
            for ID in ${OP_IDS}; do
              echo "Post comment to OpenProject OP#${ID}"
              curl -sS -X POST \
                -u "apikey:${OPENPROJECT_API_TOKEN}" \
                -H "Content-Type: application/json" \
                "${OPENPROJECT_URL%/}/api/v3/work_packages/${ID}/activities" \
                -d "$(jq -n --arg c "$COMMENT" '{comment:{raw:$c}}')" \
                >/dev/null || echo "OpenProject comment failed for OP#${ID}"
            done
          else
            echo "OpenProject creds or ids missing, skip OpenProject comments"
          fi
